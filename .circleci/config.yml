version: 2.1

jobs:
  deploy:
    machine: true
    steps:
      - checkout
      - restore_cache:
          keys:
            - python-3.6.3-202005030027
            - python-3.6.3-
      - run:
          name: install python
          command: pyenv install 3.6.3 --skip-existing
      - save_cache:
          paths:
            - /opt/circleci/.pyenv/versions/3.6.3
          key: python-3.6.3-202005030027
      - restore_cache:
          keys:
            - pipenv-202005021614-{{ checksum "Pipfile.lock" }}
            - pipenv-202005021614
            - pipenv-
      - run:
          name: install packages
          command: |
            pyenv local 3.6.3
            pip3 --version
            pip3 install --upgrade pip setuptools
            pip3 install pipenv
            PIPENV_VENV_IN_PROJECT=1 pipenv install --deploy
      - run:
          name: check versions
          command: |
            pipenv --version
            pipenv run python --version
      - save_cache:
          paths:
            - .venv
          key: pipenv-202005021614-{{ checksum "Pipfile.lock" }}
      - run:
          name: deploy to AWS Lambda
          command: |
            pipenv run sam build --use-container
            pipenv run sam package --s3-bucket ${SAM_S3_BUCKET}
            pipenv run sam deploy \
              --stack-name ${SAM_STACK_NAME} \
              --s3-bucket ${SAM_S3_BUCKET} \
              --s3-prefix ${SAM_S3_PREFIX} \
              --capabilities ${SAM_CAPABILITIES} \
              --region ${SAM_REGION} \
              --no-fail-on-empty-changeset

workflows:
  deploy:
    jobs:
      - deploy:
        filters:
          branches:
            only:
              - master
